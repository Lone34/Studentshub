{% extends "base.html" %}
{% block content %}

<div class="max-w-5xl mx-auto animate-fade-in pb-20">

    <!-- Back Navigation -->
    <div class="mb-6">
        <a href="{{ url_for('video_courses.browse_courses') }}"
            class="text-slate-500 hover:text-indigo-600 transition-colors text-sm font-medium">
            <i class="fa-solid fa-arrow-left mr-1"></i> All Courses
        </a>
    </div>

    <!-- Course Header -->
    <div class="bg-white rounded-3xl shadow-lg border border-slate-100 overflow-hidden mb-8">
        <div class="relative">
            {% if course.thumbnail_path %}
            <div class="h-64 md:h-80 relative overflow-hidden">
                <img src="{{ url_for('static', filename=course.thumbnail_path) }}" alt="{{ course.title }}"
                    class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent"></div>
                <div class="absolute bottom-6 left-8 right-8 text-white">
                    <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight mb-2">{{ course.title }}</h1>
                    <div class="flex items-center gap-4 text-sm text-white/80">
                        <span><i class="fa-solid fa-film mr-1"></i> {{ course.videos|length }} Videos</span>
                        {% if has_access %}
                        <span class="bg-emerald-500/80 px-3 py-0.5 rounded-full text-xs font-bold"><i
                                class="fa-solid fa-unlock mr-1"></i> Unlocked</span>
                        {% else %}
                        <span class="bg-white/20 backdrop-blur-sm px-3 py-0.5 rounded-full text-xs font-bold"><i
                                class="fa-solid fa-lock mr-1"></i> Locked</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="p-8 bg-gradient-to-r from-indigo-500 to-purple-600 text-white">
                <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight mb-2">{{ course.title }}</h1>
                <div class="flex items-center gap-4 text-sm text-white/80">
                    <span><i class="fa-solid fa-film mr-1"></i> {{ course.videos|length }} Videos</span>
                    {% if has_access %}
                    <span class="bg-emerald-500/80 px-3 py-0.5 rounded-full text-xs font-bold"><i
                            class="fa-solid fa-unlock mr-1"></i> Unlocked</span>
                    {% else %}
                    <span class="bg-white/20 px-3 py-0.5 rounded-full text-xs font-bold"><i
                            class="fa-solid fa-lock mr-1"></i> Locked</span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        {% if course.description %}
        <div class="px-8 py-5 border-b border-slate-100">
            <p class="text-slate-600 leading-relaxed">{{ course.description }}</p>
        </div>
        {% endif %}

        <!-- Purchase Section (if locked) -->
        {% if not has_access and course.price > 0 %}
        <div class="px-8 py-5 bg-gradient-to-r from-amber-50 to-orange-50 border-b border-orange-100">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div>
                    <h3 class="font-bold text-slate-800 mb-1"><i class="fa-solid fa-sparkles text-amber-500 mr-1"></i>
                        Unlock This Course</h3>
                    <p class="text-slate-500 text-sm">Get lifetime access to all {{ course.videos|length }} videos</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <div class="text-3xl font-black text-slate-800">â‚¹{{ course.price|int }}</div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase">One-time payment</div>
                    </div>
                    <button onclick="purchaseCourse({{ course.id }})"
                        class="bg-gradient-to-r from-orange-500 to-rose-600 hover:from-orange-600 hover:to-rose-700 text-white px-8 py-3 rounded-xl font-bold text-sm transition-all shadow-lg shadow-orange-500/30 whitespace-nowrap">
                        <i class="fa-solid fa-credit-card mr-2"></i> Purchase Now
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Videos List -->
    <div class="space-y-3">
        <h2 class="font-bold text-slate-800 text-lg mb-4 flex items-center gap-2">
            <span class="w-8 h-8 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center text-sm">
                <i class="fa-solid fa-list"></i>
            </span>
            Course Content
        </h2>

        {% if course.videos %}
        {% for video in course.videos %}
        <div
            class="bg-white rounded-xl border border-slate-100 p-4 hover:shadow-md hover:border-indigo-200 transition-all group {{ 'opacity-60' if not has_access else '' }}">
            <div class="flex items-center gap-4">
                <!-- Video Number -->
                <div
                    class="w-12 h-12 rounded-xl bg-slate-100 group-hover:bg-indigo-100 flex items-center justify-center font-black text-slate-400 group-hover:text-indigo-600 transition-colors text-lg shrink-0">
                    {{ loop.index }}
                </div>

                <!-- Video Info -->
                <div class="flex-1 min-w-0">
                    <h4 class="font-bold text-slate-800 text-sm group-hover:text-indigo-600 transition-colors truncate">
                        {{ video.title }}</h4>
                    {% if video.description %}
                    <p class="text-xs text-slate-400 truncate">{{ video.description }}</p>
                    {% endif %}
                    <div class="flex items-center gap-3 mt-1">
                        {% if video.duration_seconds > 0 %}
                        <span class="text-[10px] text-slate-400 font-medium">
                            <i class="fa-regular fa-clock mr-0.5"></i>
                            {{ (video.duration_seconds // 60) }}:{{ '%02d' % (video.duration_seconds % 60) }}
                        </span>
                        {% endif %}
                        {% if video.file_size_mb > 0 %}
                        <span class="text-[10px] text-slate-400 font-medium">
                            <i class="fa-solid fa-hard-drive mr-0.5"></i>
                            {{ video.file_size_mb }} MB
                        </span>
                        {% endif %}
                    </div>
                </div>

                <!-- Play Button -->
                {% if has_access %}
                <a href="{{ url_for('video_courses.watch_video', course_id=course.id, video_id=video.id) }}"
                    class="w-10 h-10 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white flex items-center justify-center shadow-lg shadow-indigo-500/30 transition-all shrink-0">
                    <i class="fa-solid fa-play text-sm ml-0.5"></i>
                </a>
                {% else %}
                <div
                    class="w-10 h-10 rounded-full bg-slate-200 text-slate-400 flex items-center justify-center shrink-0">
                    <i class="fa-solid fa-lock text-sm"></i>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="text-center py-12 bg-white rounded-2xl border border-dashed border-slate-200">
            <i class="fa-solid fa-film text-4xl text-slate-300 mb-3"></i>
            <p class="text-slate-500 font-medium">No videos added to this course yet.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Stripe Checkout -->
<script>
    function purchaseCourse(courseId) {
        const btn = event.target.closest('button');
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Redirecting...';

        fetch(`/courses/${courseId}/purchase`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-credit-card mr-2"></i> Purchase Now';
                    return;
                }
                window.location.href = data.checkout_url;
            })
            .catch(err => {
                alert('Payment error. Please try again.');
                console.error(err);
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-credit-card mr-2"></i> Purchase Now';
            });
    }
</script>

<style>
    @keyframes fade-in {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in {
        animation: fade-in 0.5s ease-out;
    }
</style>
{% endblock %}