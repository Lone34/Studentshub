<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutor Dashboard - Students Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .gradient-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        }

        .online-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
            }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-header text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                        <i class="fa-solid fa-chalkboard-user text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Tutor Dashboard</h1>
                        <p class="text-white/70 text-sm">Welcome, {{ tutor.display_name }}</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Online/Offline Toggle -->
                    <button id="availabilityToggle" onclick="toggleAvailability()"
                        class="flex items-center gap-2 px-4 py-2 rounded-xl transition-all {% if tutor.is_available %}bg-green-500 online-pulse{% else %}bg-gray-500{% endif %}">
                        <span
                            class="w-3 h-3 rounded-full {% if tutor.is_available %}bg-white{% else %}bg-gray-300{% endif %}"></span>
                        <span id="availabilityText">{{ 'Online' if tutor.is_available else 'Offline' }}</span>
                    </button>
                    <a href="{{ url_for('tutoring.tutor_logout') }}"
                        class="px-4 py-2 bg-white/20 rounded-xl hover:bg-white/30 transition-all">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="container mx-auto px-4 mt-4">
        {% for category, message in messages %}
        <div
            class="p-4 rounded-xl mb-2 {% if category == 'danger' %}bg-red-50 text-red-700 border border-red-200{% elif category == 'success' %}bg-green-50 text-green-700 border border-green-200{% else %}bg-blue-50 text-blue-700 border border-blue-200{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <main class="container mx-auto px-4 py-8">
        <!-- Stats Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="stat-card rounded-2xl p-5 border border-gray-100 shadow-sm">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-gray-500 text-sm font-medium">Total Sessions</span>
                    <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                        <i class="fa-solid fa-video text-purple-600"></i>
                    </div>
                </div>
                <p class="text-3xl font-bold text-gray-800">{{ stats.total_sessions }}</p>
            </div>

            <div class="stat-card rounded-2xl p-5 border border-gray-100 shadow-sm">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-gray-500 text-sm font-medium">Minutes Taught</span>
                    <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                        <i class="fa-solid fa-clock text-blue-600"></i>
                    </div>
                </div>
                <p class="text-3xl font-bold text-gray-800">{{ stats.total_minutes }}</p>
            </div>

            <div class="stat-card rounded-2xl p-5 border border-gray-100 shadow-sm">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-gray-500 text-sm font-medium">Total Earnings</span>
                    <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
                        <i class="fa-solid fa-coins text-green-600"></i>
                    </div>
                </div>
                <p class="text-3xl font-bold text-gray-800">{{ stats.total_earnings }} <span
                        class="text-lg text-gray-400">credits</span></p>
            </div>

            <div class="stat-card rounded-2xl p-5 border border-gray-100 shadow-sm">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-gray-500 text-sm font-medium">Your Rating</span>
                    <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
                        <i class="fa-solid fa-star text-amber-500"></i>
                    </div>
                </div>
                <p class="text-3xl font-bold text-gray-800">{{ "%.1f"|format(stats.rating) }}</p>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid lg:grid-cols-3 gap-6">
            <!-- Left Column: Profile & Info -->
            <div class="space-y-6">
                <!-- Profile Card -->
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-6">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-user text-purple-500"></i> Your Profile
                    </h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Display Name</span>
                            <span class="font-medium text-gray-800">{{ tutor.display_name }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Subjects</span>
                            <span class="font-medium text-gray-800">{{ tutor.subjects }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Languages</span>
                            <span class="font-medium text-gray-800">{{ tutor.languages }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Experience</span>
                            <span class="font-medium text-gray-800">{{ tutor.experience_years }} years</span>
                        </div>
                    </div>
                </div>

                <!-- Incoming Session Request (shown when student books) -->
                <div id="incomingSession" class="hidden">
                    <div
                        class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-2xl p-6 text-white animate-pulse">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <i class="fa-solid fa-bell text-2xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg">Incoming Session!</h4>
                                <p class="text-white/80 text-sm" id="incomingSubject">Subject: Loading...</p>
                            </div>
                        </div>
                        <div class="bg-white/20 rounded-xl p-4 mb-4">
                            <p class="text-sm mb-2"><strong>Student:</strong> <span id="incomingStudent">-</span></p>
                            <p class="text-sm"><strong>Question:</strong></p>
                            <p class="text-sm text-white/90" id="incomingQuestion">-</p>
                        </div>
                        <a id="joinCallBtn" href="#"
                            class="block w-full py-3 bg-white text-green-600 font-bold rounded-xl text-center hover:bg-green-50 transition-all">
                            <i class="fa-solid fa-video mr-2"></i> Join Video Call
                        </a>
                    </div>
                </div>

                <!-- Waiting for Sessions -->
                <div id="waitingCard"
                    class="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-2xl p-6 text-white {% if not tutor.is_available %}hidden{% endif %}">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <i class="fa-solid fa-satellite-dish text-2xl"></i>
                        </div>
                        <div>
                            <h4 class="font-bold">You're Online!</h4>
                            <p class="text-white/70 text-sm">Waiting for student requests...</p>
                        </div>
                    </div>
                    <div class="bg-white/20 rounded-xl p-4 text-center">
                        <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                        <p class="text-sm">When a student books you, you'll see a notification here</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Recent Sessions -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm">
                    <div class="p-6 border-b border-gray-100">
                        <h3 class="font-bold text-gray-800 flex items-center gap-2">
                            <i class="fa-solid fa-history text-purple-500"></i> Recent Sessions
                        </h3>
                    </div>
                    <div class="divide-y divide-gray-50">
                        {% if sessions %}
                        {% for session in sessions %}
                        <div class="p-4 hover:bg-gray-50 transition-colors">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                        <i class="fa-solid fa-user text-purple-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800">
                                            {{ session.subject or 'General Session' }}
                                        </p>
                                        <p class="text-sm text-gray-500">
                                            {{ session.created_at.strftime('%b %d, %Y â€¢ %I:%M %p') }}
                                        </p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="inline-block px-3 py-1 rounded-full text-xs font-medium 
                                            {% if session.status == 'completed' %}bg-green-100 text-green-700
                                            {% elif session.status == 'active' %}bg-blue-100 text-blue-700
                                            {% elif session.status == 'cancelled' %}bg-red-100 text-red-700
                                            {% else %}bg-gray-100 text-gray-700{% endif %}">
                                        {{ session.status.title() }}
                                    </span>
                                    <p class="text-sm text-gray-500 mt-1">
                                        {{ session.duration_minutes }} min
                                    </p>
                                </div>
                            </div>
                            {% if session.question %}
                            <p class="text-sm text-gray-600 mt-2 pl-14 truncate">
                                {{ session.question[:100] }}...
                            </p>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="p-8 text-center">
                            <div
                                class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fa-solid fa-video-slash text-gray-400 text-2xl"></i>
                            </div>
                            <p class="text-gray-500">No sessions yet</p>
                            <p class="text-gray-400 text-sm mt-1">Go online to receive student requests!</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Session polling variables
        let pollingInterval = null;
        let lastSessionCount = 0;

        async function toggleAvailability() {
            const btn = document.getElementById('availabilityToggle');
            const text = document.getElementById('availabilityText');
            const waitingCard = document.getElementById('waitingCard');
            const incomingSession = document.getElementById('incomingSession');

            btn.disabled = true;

            try {
                const res = await fetch('{{ url_for("tutoring.toggle_availability") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();

                if (data.success) {
                    if (data.is_available) {
                        btn.classList.remove('bg-gray-500');
                        btn.classList.add('bg-green-500', 'online-pulse');
                        btn.querySelector('span:first-child').classList.remove('bg-gray-300');
                        btn.querySelector('span:first-child').classList.add('bg-white');
                        text.textContent = 'Online';
                        waitingCard.classList.remove('hidden');
                        // Start polling when going online
                        startPolling();
                    } else {
                        btn.classList.remove('bg-green-500', 'online-pulse');
                        btn.classList.add('bg-gray-500');
                        btn.querySelector('span:first-child').classList.remove('bg-white');
                        btn.querySelector('span:first-child').classList.add('bg-gray-300');
                        text.textContent = 'Offline';
                        waitingCard.classList.add('hidden');
                        incomingSession.classList.add('hidden');
                        // Stop polling when going offline
                        stopPolling();
                    }
                }
            } catch (e) {
                console.error('Toggle failed:', e);
            }

            btn.disabled = false;
        }

        async function checkForSessions() {
            try {
                const res = await fetch('{{ url_for("tutoring.api_get_pending_sessions") }}');
                const data = await res.json();

                const incomingSession = document.getElementById('incomingSession');
                const waitingCard = document.getElementById('waitingCard');

                if (data.success && data.pending_count > 0) {
                    const session = data.sessions[0]; // Show the first pending session

                    // Update UI with session info
                    document.getElementById('incomingSubject').textContent = 'Subject: ' + session.subject;
                    document.getElementById('incomingStudent').textContent = session.student_name;
                    document.getElementById('incomingQuestion').textContent = session.question || 'No question provided';
                    document.getElementById('joinCallBtn').href = session.room_url;

                    // Show incoming session, hide waiting
                    incomingSession.classList.remove('hidden');
                    waitingCard.classList.add('hidden');

                    // Play notification sound if new session
                    if (data.pending_count > lastSessionCount) {
                        playNotificationSound();
                    }
                    lastSessionCount = data.pending_count;
                } else {
                    // No pending sessions
                    incomingSession.classList.add('hidden');
                    if (!waitingCard.classList.contains('hidden-by-offline')) {
                        const isOnline = document.getElementById('availabilityText').textContent === 'Online';
                        if (isOnline) {
                            waitingCard.classList.remove('hidden');
                        }
                    }
                    lastSessionCount = 0;
                }
            } catch (e) {
                console.error('Polling error:', e);
            }
        }

        function startPolling() {
            if (!pollingInterval) {
                checkForSessions(); // Check immediately
                pollingInterval = setInterval(checkForSessions, 3000); // Then every 3 seconds
            }
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        function playNotificationSound() {
            // Create a simple beep notification
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.3;

                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log('Could not play sound');
            }
        }

        // Start polling on page load if tutor is online
        document.addEventListener('DOMContentLoaded', function () {
            const isOnline = document.getElementById('availabilityText').textContent === 'Online';
            if (isOnline) {
                startPolling();
            }
        });
    </script>
</body>

</html>