{% extends "base.html" %}
{% block content %}

<style>
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-slide {
        animation: slideIn 0.3s ease-out forwards;
    }

    .doc-card {
        transition: all 0.3s ease;
    }

    .doc-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
    }

    .type-badge {
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        padding: 4px 10px;
        border-radius: 20px;
    }

    .type-exam {
        background: #fef3c7;
        color: #d97706;
    }

    .type-notes {
        background: #dbeafe;
        color: #2563eb;
    }

    .type-paper {
        background: #f3e8ff;
        color: #9333ea;
    }

    .type-assignment {
        background: #dcfce7;
        color: #16a34a;
    }
</style>

<div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 pb-10">
    <!-- Header -->
    <div class="max-w-6xl mx-auto pt-8 px-4 mb-6">
        <a href="{{ url_for('dashboard') }}"
            class="text-slate-500 hover:text-blue-600 font-bold text-sm flex items-center gap-2 transition-colors mb-6">
            <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
        </a>

        <div class="flex items-center justify-between flex-wrap gap-4 mb-6">
            <div class="flex items-center gap-4">
                <div
                    class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 text-white flex items-center justify-center text-2xl shadow-lg">
                    <i class="fa-solid fa-book-open"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-extrabold text-slate-800">Library</h1>
                    <p class="text-slate-500 text-sm">Browse & share study materials</p>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <div class="bg-white px-4 py-2 rounded-xl border border-slate-200 shadow-sm flex items-center gap-2">
                    <i class="fa-solid fa-bolt text-orange-500"></i>
                    <span class="font-bold text-slate-700">{{ user.credits }}</span>
                    <span class="text-xs text-slate-400">credits</span>
                </div>
                <a href="{{ url_for('library_upload') }}"
                    class="px-5 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold rounded-xl shadow-lg transition-all flex items-center gap-2">
                    <i class="fa-solid fa-cloud-upload"></i>
                    Upload & Earn
                </a>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="relative mb-6">
            <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
            <input type="text" id="search-input" placeholder="Search documents by title, topic, or content..."
                class="w-full bg-white border border-slate-200 rounded-xl pl-12 pr-4 py-4 focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-100 transition-all"
                autocomplete="off">
            <div id="search-results"
                class="absolute top-full left-0 right-0 mt-2 bg-white border border-slate-200 rounded-xl shadow-xl z-50 hidden max-h-80 overflow-y-auto">
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="flex gap-2 flex-wrap">
            <a href="{{ url_for('library', type='all') }}"
                class="px-4 py-2 rounded-lg text-sm font-bold transition-all {{ 'bg-slate-800 text-white' if current_type == 'all' else 'bg-white text-slate-600 hover:bg-slate-100' }}">
                All
            </a>
            <a href="{{ url_for('library', type='exam') }}"
                class="px-4 py-2 rounded-lg text-sm font-bold transition-all {{ 'bg-orange-500 text-white' if current_type == 'exam' else 'bg-white text-slate-600 hover:bg-slate-100' }}">
                <i class="fa-solid fa-file-lines mr-1"></i> Exams
            </a>
            <a href="{{ url_for('library', type='notes') }}"
                class="px-4 py-2 rounded-lg text-sm font-bold transition-all {{ 'bg-blue-500 text-white' if current_type == 'notes' else 'bg-white text-slate-600 hover:bg-slate-100' }}">
                <i class="fa-solid fa-note-sticky mr-1"></i> Notes
            </a>
            <a href="{{ url_for('library', type='paper') }}"
                class="px-4 py-2 rounded-lg text-sm font-bold transition-all {{ 'bg-purple-500 text-white' if current_type == 'paper' else 'bg-white text-slate-600 hover:bg-slate-100' }}">
                <i class="fa-solid fa-scroll mr-1"></i> Papers
            </a>
            <a href="{{ url_for('library', type='assignment') }}"
                class="px-4 py-2 rounded-lg text-sm font-bold transition-all {{ 'bg-green-500 text-white' if current_type == 'assignment' else 'bg-white text-slate-600 hover:bg-slate-100' }}">
                <i class="fa-solid fa-clipboard mr-1"></i> Assignments
            </a>
        </div>
    </div>

    <!-- Documents Grid -->
    <div class="max-w-6xl mx-auto px-4">
        {% if documents %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for doc in documents %}
            <a href="{{ url_for('library_document', doc_id=doc.id) }}"
                class="doc-card bg-white rounded-2xl border border-slate-100 overflow-hidden block animate-slide"
                style="animation-delay: {{ loop.index * 50 }}ms">

                <!-- Preview / Thumbnail -->
                <div
                    class="h-32 bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center relative">
                    {% if doc.file_type == 'pdf' %}
                    <i class="fa-solid fa-file-pdf text-5xl text-red-400"></i>
                    {% else %}
                    <i class="fa-solid fa-image text-5xl text-blue-400"></i>
                    {% endif %}

                    <!-- Type Badge -->
                    <span class="type-badge type-{{ doc.doc_type }} absolute top-3 left-3">
                        {{ doc.doc_type }}
                    </span>

                    <!-- Lock Status -->
                    {% if doc.id in unlocked_ids or doc.user_id == user.id %}
                    <span
                        class="absolute top-3 right-3 w-7 h-7 rounded-full bg-green-500 text-white flex items-center justify-center text-xs">
                        <i class="fa-solid fa-unlock"></i>
                    </span>
                    {% else %}
                    <span
                        class="absolute top-3 right-3 w-7 h-7 rounded-full bg-slate-400 text-white flex items-center justify-center text-xs">
                        <i class="fa-solid fa-lock"></i>
                    </span>
                    {% endif %}
                </div>

                <!-- Content -->
                <div class="p-4">
                    <h3 class="font-bold text-slate-800 mb-1 line-clamp-1">{{ doc.title }}</h3>
                    <p class="text-xs text-slate-500 mb-3 line-clamp-2">{{ doc.description or 'No description' }}</p>

                    <div class="flex items-center justify-between text-xs text-slate-400">
                        <span><i class="fa-solid fa-user mr-1"></i> {{ doc.user.username }}</span>
                        <span><i class="fa-solid fa-download mr-1"></i> {{ doc.downloads }}</span>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-16">
            <div class="w-20 h-20 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-folder-open text-3xl text-slate-400"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-700 mb-2">No documents yet</h3>
            <p class="text-slate-500 mb-6">Be the first to upload and earn credits!</p>
            <a href="{{ url_for('library_upload') }}"
                class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition-all">
                <i class="fa-solid fa-cloud-upload"></i> Upload Document
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    let searchTimeout;

    searchInput.addEventListener('input', function () {
        clearTimeout(searchTimeout);
        const query = this.value.trim();

        if (query.length < 2) {
            searchResults.classList.add('hidden');
            return;
        }

        searchTimeout = setTimeout(async () => {
            try {
                const response = await fetch(`/api/library/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.results.length === 0) {
                    searchResults.innerHTML = '<div class="p-4 text-slate-500 text-center">No results found</div>';
                } else {
                    searchResults.innerHTML = data.results.map(doc => `
                    <a href="/library/document/${doc.id}" class="flex items-center gap-3 p-3 hover:bg-slate-50 border-b border-slate-100 last:border-0">
                        <div class="w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center flex-shrink-0">
                            <i class="fa-solid fa-file-lines text-slate-400"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-slate-800 text-sm truncate">${doc.title}</h4>
                            <p class="text-xs text-slate-500">${doc.doc_type} â€¢ by ${doc.uploader}</p>
                        </div>
                        ${doc.is_unlocked ? '<i class="fa-solid fa-unlock text-green-500"></i>' : '<i class="fa-solid fa-lock text-slate-400"></i>'}
                    </a>
                `).join('');
                }

                searchResults.classList.remove('hidden');
            } catch (err) {
                console.error('Search error:', err);
            }
        }, 300);
    });

    // Hide results when clicking outside
    document.addEventListener('click', function (e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.classList.add('hidden');
        }
    });
</script>

{% endblock %}