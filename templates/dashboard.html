{% extends "base.html" %}
{% block content %}

<style>
    /* Animations matching Landing Page */
    @keyframes float {

        0%,
        100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-10px);
        }
    }

    .delay-300 {
        animation-delay: 0.3s;
    }

    .delay-350 {
        animation-delay: 0.35s;
    }

    .animate-float {
        animation: float 6s ease-in-out infinite;
    }

    .dashboard-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
</style>

<div id="hub-view" class="max-w-7xl mx-auto">

    <div class="mb-12 text-center md:text-left relative">
        <div class="absolute top-0 right-0 -mt-10 w-64 h-64 bg-orange-500/10 rounded-full blur-3xl animate-float -z-10">
        </div>

        <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 tracking-tight mb-2">
            Welcome back, <span class="text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-rose-600">{{
                user.username }}</span>.
        </h1>
        <p class="text-slate-500 text-lg">Your academic command center is ready.</p>

        {% if user.role in ['admin', 'super_admin'] %}
        <div class="mt-4 flex gap-3 justify-center md:justify-start">
            <a href="{{ url_for('admin') }}"
                class="inline-flex items-center gap-2 px-4 py-2 bg-slate-800 text-white rounded-lg text-xs font-bold hover:bg-slate-700 transition">
                <i class="fa-solid fa-shield-halved"></i> Admin Panel
            </a>
            {% if user.role == 'super_admin' %}
            <a href="{{ url_for('super_admin_dashboard') }}"
                class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-500 transition">
                <i class="fa-solid fa-user-astronaut"></i> Super Admin
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Subscription Status -->
    <div
        class="mb-8 p-6 bg-white rounded-3xl border border-slate-100 shadow-sm flex flex-col md:flex-row items-center justify-between gap-6">
        <div>
            <h2 class="text-lg font-bold text-slate-900 flex items-center gap-2">
                <i class="fa-solid fa-crown text-amber-500"></i> Current Plan:
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-amber-500 to-orange-600">
                    {% if user.role in ['admin', 'super_admin'] %}
                    Unlimited Admin Access
                    {% elif user.active_subscription_id %}
                    Premium Member
                    {% else %}
                    Free Tier
                    {% endif %}
                </span>
            </h2>
            <p class="text-slate-500 text-sm mt-1">
                {% if user.active_subscription_id %}
                Your subscription is active. Enjoy full access!
                {% elif user.role in ['admin', 'super_admin'] %}
                You have unrestricted access to all features.
                {% else %}
                You are on the limited usage free tier. Upgrade to unlock more.
                {% endif %}
            </p>
        </div>

        {% if not user.active_subscription_id and user.role not in ['admin', 'super_admin'] %}
        <a href="{{ url_for('payments.pricing') }}"
            class="px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-600 text-white font-bold rounded-xl shadow-lg shadow-orange-500/30 hover:shadow-orange-500/50 transition transform hover:-translate-y-0.5">
            Upgrade Now <i class="fa-solid fa-arrow-right ml-2"></i>
        </a>
        {% endif %}
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">

        <div onclick="openTool()"
            class="dashboard-card group p-8 rounded-3xl bg-white border border-slate-100 cursor-pointer relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                <i class="fa-solid fa-brain text-6xl text-rose-500"></i>
            </div>
            <div class="w-14 h-14 bg-rose-100 rounded-2xl flex items-center justify-center text-rose-600 text-2xl mb-6">
                <i class="fa-solid fa-pen-to-square"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Homework Helper</h3>
            <p class="text-slate-500 text-sm mb-4">Post questions to experts, use OCR for images, and get detailed
                solutions.</p>
            <span class="text-rose-600 font-bold text-sm flex items-center gap-2">Launch Tool <i
                    class="fa-solid fa-arrow-right"></i></span>
        </div>

        <a href="{{ url_for('unblur') }}"
            class="dashboard-card group p-8 rounded-3xl bg-white border border-slate-100 cursor-pointer relative overflow-hidden block">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                <i class="fa-solid fa-unlock text-6xl text-indigo-500"></i>
            </div>
            <div
                class="w-14 h-14 bg-indigo-100 rounded-2xl flex items-center justify-center text-indigo-600 text-2xl mb-6">
                <i class="fa-solid fa-unlock-keyhole"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Unblur Answers</h3>
            <p class="text-slate-500 text-sm mb-4">Paste a Chegg URL to instantly view the solution without waiting.</p>
            <span class="text-indigo-600 font-bold text-sm flex items-center gap-2">Unblur Now <i
                    class="fa-solid fa-arrow-right"></i></span>
        </a>

        <a href="{{ url_for('ai_tutor') }}"
            class="dashboard-card group p-8 rounded-3xl bg-white border border-slate-100 cursor-pointer relative overflow-hidden block">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                <i class="fa-solid fa-robot text-6xl text-emerald-500"></i>
            </div>
            <div
                class="w-14 h-14 bg-emerald-100 rounded-2xl flex items-center justify-center text-emerald-600 text-2xl mb-6">
                <i class="fa-solid fa-microchip"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Dual AI Tutor</h3>
            <p class="text-slate-500 text-sm mb-4">Compare answers from ChatGPT and Gemini simultaneously.</p>
            <span class="text-emerald-600 font-bold text-sm flex items-center gap-2">Start Chat <i
                    class="fa-solid fa-arrow-right"></i></span>
        </a>

        <a href="{{ url_for('tutoring.browse_tutors') }}"
            class="dashboard-card group p-8 rounded-3xl bg-white border border-slate-100 cursor-pointer relative overflow-hidden block">
            <div
                class="w-14 h-14 bg-amber-100 rounded-2xl flex items-center justify-center text-amber-600 text-2xl mb-6">
                <i class="fa-solid fa-video"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Live Tutoring</h3>
            <p class="text-slate-500 text-sm mb-4">Book 1-on-1 video sessions with whiteboard support.</p>
            <span class="text-amber-600 font-bold text-sm flex items-center gap-2">Find Tutor <i
                    class="fa-solid fa-arrow-right"></i></span>
        </a>

        <div onclick="openSessions()"
            class="dashboard-card group p-8 rounded-3xl bg-white border border-slate-100 cursor-pointer relative overflow-hidden">
            <div class="w-14 h-14 bg-cyan-100 rounded-2xl flex items-center justify-center text-cyan-600 text-2xl mb-6">
                <i class="fa-solid fa-film"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">My Recordings</h3>
            <p class="text-slate-500 text-sm mb-4">Watch past tutoring sessions and review your learning history.</p>
            <span class="text-cyan-600 font-bold text-sm flex items-center gap-2">View Archive <i
                    class="fa-solid fa-arrow-right"></i></span>
        </div>

        <a href="{{ url_for('library') }}"
            class="dashboard-card group p-8 rounded-3xl bg-white border border-slate-100 cursor-pointer relative overflow-hidden block">
            <div class="w-14 h-14 bg-blue-100 rounded-2xl flex items-center justify-center text-blue-600 text-2xl mb-6">
                <i class="fa-solid fa-book-open"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Library</h3>
            <p class="text-slate-500 text-sm mb-4">Download notes, upload papers, and earn credits.</p>
            <span class="text-blue-600 font-bold text-sm flex items-center gap-2">Browse Docs <i
                    class="fa-solid fa-arrow-right"></i></span>
        </a>
    </div>
    <a href="{{ url_for('school.index') }}"
        class="dashboard-card group p-8 rounded-3xl bg-white border border-slate-100 cursor-pointer relative overflow-hidden block">
        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
            <i class="fa-solid fa-school text-6xl text-violet-500"></i>
        </div>
        <div class="w-14 h-14 bg-violet-100 rounded-2xl flex items-center justify-center text-violet-600 text-2xl mb-6">
            <i class="fa-solid fa-chalkboard-user"></i>
        </div>
        <h3 class="text-xl font-bold text-slate-900 mb-2">Online School</h3>
        <p class="text-slate-500 text-sm mb-4">Join live video classes, view schedules, and attend subjects.</p>
        <span class="text-violet-600 font-bold text-sm flex items-center gap-2">Enter School <i
                class="fa-solid fa-arrow-right"></i></span>
    </a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-1 bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
        <h4 class="font-bold text-slate-900 mb-4 flex items-center gap-2">
            <i class="fa-solid fa-magnifying-glass text-slate-400"></i> Quick Search
        </h4>
        <div class="relative">
            <input type="text" id="dashboard-search" placeholder="Search notes, exams..."
                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-orange-500 transition">
            <div id="dashboard-search-results"
                class="absolute top-full left-0 right-0 mt-2 bg-white border border-slate-100 rounded-xl shadow-xl z-20 hidden max-h-60 overflow-y-auto">
            </div>
        </div>
    </div>

    <div
        class="lg:col-span-2 bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex items-center justify-between">
        <div>
            <h4 class="font-bold text-slate-900 mb-1">Recent Activity</h4>
            {% if jobs %}
            {% set latest = jobs[0] %}
            <p class="text-sm text-slate-500">
                <span class="font-semibold text-slate-700">{{ latest.subject }}</span> -
                <span class="{{ 'text-green-500' if latest.status == 'Completed' else 'text-red-500' }} font-bold">{{
                    latest.status }}</span>
            </p>
            {% else %}
            <p class="text-sm text-slate-500">No activity yet.</p>
            {% endif %}
        </div>
        <button onclick="openTool(); switchTab('history')"
            class="px-4 py-2 bg-slate-50 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-100 transition">
            View Full History
        </button>
    </div>

    <!-- Feedback Section -->
    <div class="lg:col-span-3 bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
        <h4 class="font-bold text-slate-900 mb-4"><i class="fa-solid fa-comment-dots text-orange-500 mr-2"></i> Share
            Your Experience</h4>
        <form action="{{ url_for('submit_feedback') }}" method="POST" class="flex flex-col gap-4">
            <textarea name="content" rows="3" placeholder="Tell us how we helped you! (Minimum 10 words to be featured)"
                class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 text-sm focus:outline-none focus:border-orange-500"></textarea>
            <button type="submit"
                class="self-end px-6 py-2 bg-slate-800 text-white rounded-xl font-bold text-sm hover:bg-slate-700 transition">
                Submit Feedback
            </button>
        </form>
    </div>
</div>
</div>

<div id="tool-view" class="hidden max-w-5xl mx-auto">
    <div class="flex items-center justify-between mb-8">
        <button onclick="closeTool()"
            class="text-slate-500 hover:text-orange-600 font-bold text-sm flex items-center gap-2 transition">
            <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
        </button>
        <h2 class="text-2xl font-bold text-slate-900">Homework Helper</h2>
    </div>

    <div class="flex gap-4 mb-8">
        <button id="btn-post" onclick="switchTab('post')"
            class="px-6 py-2 rounded-xl bg-orange-500 text-white font-bold text-sm shadow-lg shadow-orange-500/30 transition">New
            Question</button>
        <button id="btn-history" onclick="switchTab('history')"
            class="px-6 py-2 rounded-xl bg-white text-slate-500 border border-slate-200 font-bold text-sm hover:bg-slate-50 transition">History
            Log</button>
    </div>

    <div id="view-post" class="bg-white rounded-3xl border border-slate-100 shadow-sm p-8">
        <form method="POST" id="postForm" class="space-y-6" onsubmit="return handleFormSubmit(event)">

            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">1. Select Service
                    Account</label>
                <div class="relative">
                    <select name="account_id" id="account_select" onchange="checkBalance()"
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-orange-500 appearance-none">
                        {% for acc in accounts %}
                        <option value="{{ acc.id }}">{{ acc.name }}</option>
                        {% endfor %}
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-4 top-3.5 text-slate-400 pointer-events-none"></i>
                </div>
                <div id="balance-display" class="hidden mt-2 text-xs">
                    <span class="text-slate-400">Balance:</span> <span id="balance-value"
                        class="font-bold text-slate-700">Checking...</span>
                </div>
            </div>

            <div class="bg-slate-50 p-2 rounded-xl inline-flex gap-2">
                <button type="button" onclick="switchMode('text')" id="btn-mode-text"
                    class="px-4 py-2 rounded-lg bg-white text-slate-800 shadow-sm text-xs font-bold">Text</button>
                <button type="button" onclick="switchMode('image')" id="btn-mode-image"
                    class="px-4 py-2 rounded-lg text-slate-500 hover:text-slate-800 text-xs font-bold">Image +
                    OCR</button>
                <button type="button" onclick="switchMode('repost')" id="btn-mode-repost"
                    class="px-4 py-2 rounded-lg text-slate-500 hover:text-slate-800 text-xs font-bold">Repost
                    URL</button>
            </div>
            <input type="hidden" name="post_mode" id="post_mode" value="text">
            <input type="hidden" name="final_image_url" id="final_image_url">

            <div id="container-text">
                <textarea name="content" id="question_content" rows="4"
                    class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 text-sm focus:outline-none focus:border-orange-500"
                    placeholder="Type your question here..."></textarea>
            </div>

            <div id="container-image" class="hidden">
                <div
                    class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center cursor-pointer hover:bg-slate-50 transition relative">
                    <input type="file" id="imageInput" accept="image/*"
                        class="absolute inset-0 opacity-0 cursor-pointer" onchange="uploadImage()">
                    <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 mb-2"></i>
                    <p class="text-sm text-slate-500 font-bold">Click to upload image</p>
                    <div id="upload-loading" class="hidden mt-2 text-orange-500 font-bold text-xs">Processing...</div>
                </div>
                <div id="ocr-preview" class="hidden mt-4 flex gap-4">
                    <img id="img-preview-src" class="h-32 rounded-lg border border-slate-200">
                    <textarea id="ocr_editor"
                        class="flex-1 bg-slate-50 border border-slate-200 rounded-xl p-3 text-xs font-mono"></textarea>
                </div>
            </div>

            <div id="container-repost" class="hidden space-y-4">
                <div class="flex gap-2">
                    <input type="text" id="repost_url"
                        class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-orange-500"
                        placeholder="Paste Chegg Question URL">
                    <button type="button" onclick="extractQuestion()" id="extractBtn"
                        class="px-4 py-2 bg-slate-800 text-white rounded-xl font-bold text-xs">Extract</button>
                </div>
                <div id="repost-preview" class="hidden bg-green-50 border border-green-100 p-4 rounded-xl">
                    <p class="text-green-700 font-bold text-sm mb-2"><i class="fa-solid fa-check"></i> Extracted!</p>
                    <div id="repost-content" class="text-xs text-slate-600 max-h-32 overflow-y-auto mb-2"></div>
                    <textarea id="repost_ocr_editor"
                        class="w-full bg-white border border-green-200 rounded-lg p-2 text-xs font-mono"
                        placeholder="Extracted text..."></textarea>
                    <div class="mt-2 flex items-center gap-2">
                        <input type="checkbox" id="include_ocr_text" checked
                            class="text-orange-500 focus:ring-orange-500">
                        <label for="include_ocr_text" class="text-xs text-slate-500">Include text in post</label>
                    </div>
                    <input type="hidden" id="extracted_html" name="extracted_html">
                </div>
                <div id="repost-error" class="hidden text-red-500 text-xs font-bold"></div>
            </div>

            <div>
                <button type="button" onclick="fetchSubjects()" id="searchBtn"
                    class="w-full py-3 border border-dashed border-slate-300 text-slate-500 rounded-xl text-sm font-bold hover:bg-slate-50 transition mb-4">
                    <i class="fa-solid fa-magnifying-glass"></i> Find Subject
                </button>
                <div id="subject-step" class="opacity-50 pointer-events-none transition">
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">3. Target
                        Subject</label>
                    <select name="subject_select" id="subject_dropdown"
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-orange-500">
                        <option disabled selected>Wait for search...</option>
                    </select>
                </div>
            </div>

            <div class="flex gap-4">
                <select name="post_count"
                    class="w-24 bg-slate-50 border border-slate-200 rounded-xl px-3 py-3 text-sm font-bold">
                    <option value="1">1 Post</option>
                    <option value="2">2 Posts</option>
                </select>
                <button type="submit" id="postBtn"
                    class="flex-1 bg-gradient-to-r from-orange-500 to-rose-600 text-white font-bold rounded-xl py-3 shadow-lg hover:shadow-orange-500/30 transition transform hover:-translate-y-0.5">
                    Launch Process <i class="fa-solid fa-rocket ml-2"></i>
                </button>
            </div>
        </form>
    </div>

    <div id="view-history" class="hidden bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
        <table class="w-full text-left">
            <thead class="bg-slate-50 border-b border-slate-100">
                <tr>
                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase">ID</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase">Subject</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase">Status</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase text-right">Time</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-50">
                {% for job in jobs %}
                <tr onclick="showDetails(this)" class="hover:bg-slate-50 cursor-pointer transition">
                    <td class="px-6 py-4 text-xs font-mono text-slate-500">#{{ job.id }}</td>
                    <td class="px-6 py-4 text-sm font-bold text-slate-700">{{ job.subject }}</td>
                    <td class="px-6 py-4">
                        <span
                            class="px-2 py-1 rounded-full text-[10px] font-bold 
                            {% if job.status == 'Completed' %}bg-green-100 text-green-700{% elif job.status == 'Failed' %}bg-red-100 text-red-700{% else %}bg-yellow-100 text-yellow-700{% endif %}">
                            {{ job.status }}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right text-xs text-slate-400 utc-time" data-time="{{ job.timestamp }}">{{
                        job.timestamp }}</td>

                    <td class="hidden data-storage">
                        <div class="raw-subject">{{ job.subject }}</div>
                        <div class="raw-content">{{ job.content }}</div>
                        <div class="raw-result">{{ job.result_message }}</div>
                        <div class="raw-status">{{ job.status }}</div>
                        <div class="raw-time">{{ job.timestamp }}</div>
                        <div class="raw-account">{{ job.service_account_name }}</div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="session-view" class="hidden max-w-5xl mx-auto">
    <div class="flex items-center justify-between mb-8">
        <button onclick="closeSessions()"
            class="text-slate-500 hover:text-cyan-600 font-bold text-sm flex items-center gap-2 transition">
            <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
        </button>
        <h2 class="text-2xl font-bold text-slate-900">My Recordings</h2>
    </div>

    <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
        {% if sessions %}
        <table class="w-full text-left">
            <thead class="bg-slate-50 border-b border-slate-100">
                <tr>
                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase">Date</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase">Tutor</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase">Duration</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase text-right">Action</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-50">
                {% for session in sessions %}
                <tr class="hover:bg-slate-50 transition">
                    <td class="px-6 py-4 text-sm font-bold text-slate-700">
                        {{ session.created_at.strftime('%Y-%m-%d') }}
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-600">{{ session.tutor.display_name if session.tutor else
                        'Unknown' }}</td>
                    <td class="px-6 py-4 text-xs font-mono text-slate-500">{{ "%.1f"|format(session.duration_minutes) }}
                        min</td>
                    <td class="px-6 py-4 text-right">
                        {% if session.recording_path %}
                        <a href="/{{ session.recording_path }}" target="_blank"
                            class="inline-flex items-center gap-2 px-3 py-1 bg-cyan-50 text-cyan-600 rounded-lg text-xs font-bold hover:bg-cyan-100 transition">
                            <i class="fa-solid fa-play"></i> Watch
                        </a>
                        {% else %}
                        <span class="text-xs text-slate-400 italic">No Recording</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="p-12 text-center text-slate-500">
            <i class="fa-solid fa-video-slash text-4xl mb-4 text-slate-300"></i>
            <p>No sessions recorded yet.</p>
        </div>
        {% endif %}
    </div>
</div>

<div id="detailsModal" class="fixed inset-0 z-50 hidden"
    style="background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px);">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden animate-float">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-900">Job Details</h3>
                <button onclick="closeDetails()" class="text-slate-400 hover:text-slate-600"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <span class="text-xs font-bold text-slate-400 uppercase">Subject</span>
                    <p id="modalSubject" class="font-bold text-slate-800"></p>
                </div>
                <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <span class="text-xs font-bold text-slate-400 uppercase">Result Message</span>
                    <p id="modalResult" class="text-sm text-slate-600 mt-1"></p>
                </div>
                <div>
                    <span class="text-xs font-bold text-slate-400 uppercase">Content sent</span>
                    <div id="modalQuestion"
                        class="bg-slate-900 text-slate-300 p-3 rounded-xl text-xs font-mono max-h-32 overflow-y-auto mt-1">
                    </div>
                </div>
                <div class="text-right">
                    <span id="modalTime" class="text-xs text-slate-400"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- View Switching ---
    function openTool() {
        document.getElementById('hub-view').classList.add('hidden');
        document.getElementById('tool-view').classList.remove('hidden');
        window.scrollTo(0, 0);
    }
    function closeTool() {
        document.getElementById('tool-view').classList.add('hidden');
        document.getElementById('hub-view').classList.remove('hidden');
    }
    function openSessions() {
        document.getElementById('hub-view').classList.add('hidden');
        document.getElementById('session-view').classList.remove('hidden');
        window.scrollTo(0, 0);
    }
    function closeSessions() {
        document.getElementById('session-view').classList.add('hidden');
        document.getElementById('hub-view').classList.remove('hidden');
    }
    function switchTab(tab) {
        if (tab === 'post') {
            document.getElementById('view-post').classList.remove('hidden');
            document.getElementById('view-history').classList.add('hidden');
            document.getElementById('btn-post').classList.add('bg-orange-500', 'text-white', 'shadow-lg');
            document.getElementById('btn-post').classList.remove('bg-white', 'text-slate-500', 'border');
            document.getElementById('btn-history').classList.remove('bg-orange-500', 'text-white', 'shadow-lg');
            document.getElementById('btn-history').classList.add('bg-white', 'text-slate-500', 'border');
        } else {
            document.getElementById('view-post').classList.add('hidden');
            document.getElementById('view-history').classList.remove('hidden');
            document.getElementById('btn-history').classList.add('bg-orange-500', 'text-white', 'shadow-lg');
            document.getElementById('btn-history').classList.remove('bg-white', 'text-slate-500', 'border');
            document.getElementById('btn-post').classList.remove('bg-orange-500', 'text-white', 'shadow-lg');
            document.getElementById('btn-post').classList.add('bg-white', 'text-slate-500', 'border');
        }
    }

    // --- Mode Switching (Text vs Image vs Repost) ---
    function switchMode(mode) {
        document.getElementById('post_mode').value = mode;

        // Reset Styles
        ['text', 'image', 'repost'].forEach(m => {
            const btn = document.getElementById('btn-mode-' + m);
            btn.classList.remove('bg-white', 'text-slate-800', 'shadow-sm');
            btn.classList.add('text-slate-500');
            document.getElementById('container-' + m).classList.add('hidden');
        });

        // Activate Selected
        const activeBtn = document.getElementById('btn-mode-' + mode);
        activeBtn.classList.add('bg-white', 'text-slate-800', 'shadow-sm');
        activeBtn.classList.remove('text-slate-500');
        document.getElementById('container-' + mode).classList.remove('hidden');
    }

    // --- Modal Logic ---
    function showDetails(row) {
        const d = row.querySelector('.data-storage');
        document.getElementById('modalSubject').innerText = d.querySelector('.raw-subject').innerText;
        document.getElementById('modalResult').innerText = d.querySelector('.raw-result').innerText;
        document.getElementById('modalQuestion').innerText = d.querySelector('.raw-content').innerText;

        const dateObj = new Date(d.querySelector('.raw-time').innerText + " UTC");
        document.getElementById('modalTime').innerText = dateObj.toLocaleString();

        document.getElementById('detailsModal').classList.remove('hidden');
    }
    function closeDetails() {
        document.getElementById('detailsModal').classList.add('hidden');
    }

    // --- API & Logic Functions ---
    // (Pasted from your original file, cleaned up)

    function checkBalance() {
        const accId = document.getElementById('account_select').value;
        const display = document.getElementById('balance-display');
        const valSpan = document.getElementById('balance-value');
        if (!accId) return;
        display.classList.remove('hidden');
        valSpan.innerText = "Checking...";
        fetch('/api/check_balance', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ account_id: accId })
        }).then(res => res.json()).then(data => {
            if (data.balance && typeof data.balance === 'object') {
                valSpan.innerText = data.balance.remaining !== undefined ? data.balance.remaining : (data.balance.used + '/' + data.balance.limit);
            } else { valSpan.innerText = data.balance || "Error"; }
        });
    }

    function uploadImage() {
        const input = document.getElementById('imageInput');
        if (!input.files[0]) return;
        document.getElementById('upload-loading').classList.remove('hidden');

        const formData = new FormData();
        formData.append('file', input.files[0]);
        formData.append('account_id', document.getElementById('account_select').value);

        fetch('/api/process_image', { method: 'POST', body: formData })
            .then(res => res.json()).then(data => {
                document.getElementById('upload-loading').classList.add('hidden');
                if (data.success) {
                    document.getElementById('ocr-preview').classList.remove('hidden');
                    document.getElementById('img-preview-src').src = data.image_url;
                    document.getElementById('final_image_url').value = data.image_url;
                    document.getElementById('ocr_editor').value = data.transcribed_text;
                    document.getElementById('question_content').value = data.transcribed_text;
                } else { alert(data.error); }
            });
    }

    document.getElementById('ocr_editor').addEventListener('input', e => {
        document.getElementById('question_content').value = e.target.value;
    });

    function fetchSubjects() {
        const mode = document.getElementById('post_mode').value;
        const qText = mode === 'image' ? document.getElementById('ocr_editor').value : document.getElementById('question_content').value;
        if (qText.length < 5) { alert("Enter text first"); return; }

        const btn = document.getElementById('searchBtn');
        const drop = document.getElementById('subject_dropdown');
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Searching...';
        document.getElementById('subject-step').classList.remove('opacity-50', 'pointer-events-none');

        fetch('/api/get_suggested_subjects', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question_text: qText, account_id: document.getElementById('account_select').value })
        }).then(res => res.json()).then(data => {
            btn.innerHTML = '<i class="fa-solid fa-check"></i> Found!';
            drop.innerHTML = "";
            if (data.subjects) {
                drop.add(new Option("Select Subject...", "", true, true));
                data.subjects.forEach(s => drop.add(new Option(s.title, s.title + '|' + s.subjectId + '|' + s.groupId)));
            } else { drop.add(new Option("No subjects found", "")); }
        });
    }

    function extractQuestion() {
        const url = document.getElementById('repost_url').value;
        const btn = document.getElementById('extractBtn');
        if (!url) return;
        btn.innerText = "...";
        fetch('/api/chegg/extract-question', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url })
        }).then(res => res.json()).then(data => {
            btn.innerText = "Extract";
            if (data.success) {
                document.getElementById('repost-preview').classList.remove('hidden');
                document.getElementById('repost-content').innerHTML = data.content_html || data.plain_text;
                document.getElementById('repost_ocr_editor').value = data.ocr_text || "";
                document.getElementById('extracted_html').value = data.content_html;
                document.getElementById('question_content').value = data.plain_text;

                // Auto subject
                if (data.subject) {
                    document.getElementById('subject-step').classList.remove('opacity-50', 'pointer-events-none');
                    const drop = document.getElementById('subject_dropdown');
                    drop.innerHTML = "";
                    const val = data.subject.subjectId ? (data.subject.title + '|' + data.subject.subjectId + '|' + data.subject.groupId) : data.subject.title;
                    drop.add(new Option(data.subject.title + " (Auto)", val, true, true));
                }
            } else { alert(data.error); }
        });
    }

    function handleFormSubmit(e) {
        if (document.getElementById('post_mode').value !== 'repost') return true;
        e.preventDefault();

        const btn = document.getElementById('postBtn');
        const oldText = btn.innerHTML;
        btn.innerHTML = "Processing...";
        btn.disabled = true;

        let html = document.getElementById('extracted_html').value;
        if (document.getElementById('include_ocr_text').checked) {
            html = "<p>" + document.getElementById('repost_ocr_editor').value + "</p>" + html;
        }

        fetch('/api/chegg/repost', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                content_html: html,
                subject: document.getElementById('subject_dropdown').value,
                account_id: document.getElementById('account_select').value,
                post_count: document.querySelector('select[name="post_count"]').value
            })
        }).then(res => res.json()).then(data => {
            alert(data.message || data.error);
            window.location.reload();
        });
    }

    // Convert UTC times
    document.querySelectorAll('.utc-time').forEach(el => {
        const d = new Date(el.getAttribute('data-time') + " UTC");
        if (!isNaN(d)) el.innerText = d.toLocaleString();
    });
</script>

{% endblock %}